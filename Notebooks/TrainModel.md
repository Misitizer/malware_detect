

```python
import pickle
import os
from malware_ml.prepare_data import df_for_bayes, df_to_pool
import catboost as cb
import pandas as pd
from sklearn.model_selection import train_test_split
from sklearn.naive_bayes import GaussianNB
import matplotlib.pyplot as plt
%matplotlib inline
from malware_ml.visualization import plot_roc_curve
from malware_ml.model import load_model
```


```python
df = pd.read_csv('../DataSets/train.csv')
```


```python
seed = 2019
hold_part = 0.02
val_part = 0.3

train_val_data, hold_data = train_test_split(df, test_size=hold_part, random_state=seed)
train_data, val_data = train_test_split(train_val_data, test_size=val_part, random_state=seed)
```


```python
train_data.to_csv('../data/train_data.csv', index=False)
val_data.to_csv('../data/val_data.csv', index=False)
hold_data.to_csv('../data/hold_data.csv', index=False)
```


```python
train_data_b = df_for_bayes(train_data)
train_val_b = df_for_bayes(val_data)
```


```python
target = train_data_b['HasDetections']
del train_data_b['HasDetections']

val_target = train_val_b['HasDetections']
del train_val_b['HasDetections']
```


```python
%%time
simple_model = GaussianNB()
simple_model.fit(train_data_b.fillna(0), target)
```


```python
plt.figure(figsize=(10,10))
plot_roc_curve(true = val_target,
               pred=simple_model.predict_proba(train_val_b.fillna(0))[:,1],
               name='ROC-кривая на валидационном датасете')
```


```python
hold_data_b = df_for_bayes(hold_data)
hold_target = hold_data_b['HasDetections']
del hold_data_b['HasDetections']
```


```python
plt.figure(figsize=(10,10))
plot_roc_curve(true = hold_target,
               pred=simple_model.predict_proba(hold_data_b.fillna(0))[:,1],
               name='ROC-кривая на отложенном датасете')
```


```python
pickle.dump(simple_model, open('../models/simple_model.sav','wb'))
```


```python
model = cb.CatBoostClassifier(iterations=100)
train_pool = df_to_pool(train_data)
val_pool = df_to_pool(val_data)


```


```python
%%time
model = cb.CatBoostClassifier(iterations=20)
model.fit(train_pool, eval_set=val_pool, verbose=True)
```


```python
plt.figure(figsize=(10,10))
plot_roc_curve(true=val_pool.get_label(),
               pred=model.predict_proba(val_pool)[:,1],
               name='ROC-кривая на валидационном датасете')
```


```python
hold_pool = df_to_pool(hold_data)
```


```python
plt.figure(figsize=(10,10))
plot_roc_curve(true=hold_pool.get_label(),
               pred=model.predict_proba(hold_pool)[:,1],
               name='ROC-кривая на отложенном датасете')
```


```python
path = '/models/model.cbm'
model.save_model(path)

```


```python
loaded = pickle.load(open('../models/simple_model.sav', 'rb'))

loaded_cb = load_model(path)
```
